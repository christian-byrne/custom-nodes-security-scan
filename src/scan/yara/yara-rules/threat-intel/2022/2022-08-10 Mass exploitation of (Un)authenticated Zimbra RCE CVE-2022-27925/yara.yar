rule webshell_jsp_godzilla : Webshells Commodity
{
    meta:
        author = "threatintel@volexity.com"
        description = "Detects the JSP implementation of the Godzilla Webshell."
        date = "2021-11-08"
        hash1 = "2786d2dc738529a34ecde10ffeda69b7f40762bf13e7771451f13a24ab7fc5fe"
        license = "See license at https://github.com/volexity/threat-intel/blob/main/LICENSE.txt"
        reference = "https://github.com/BeichenDream/Godzilla"
        reference2 = "https://unit42.paloaltonetworks.com/manageengine-godzilla-nglite-kdcsponge/"
        memory_suitable = 1

    strings:
        $s1 = ".getWriter().write(base64Encode(" wide ascii
        $s2 = ".getAttribute(" ascii wide
        $s3 = "java.security.MessageDigest" ascii wide
        
        $auth1 = /String xc=\"[a-f0-9]{16}\"/ ascii wide
        $auth2 = "String pass=\"" ascii wide
        
        $magic = "class X extends ClassLoader{public X(ClassLoader z){super(z);}public Class Q"
        $magic2 = "<%@page import=\"java.util.*,javax.crypto.*,javax.crypto.spec.*\"%><%!class"

    condition:
        all of ($s*) or
        all of ($auth*) or 
        any of ($magic*)
}

rule webshell_jsp_general_runtime_exec_req: General Webshells
{
    meta:
        author = "threatintel@volexity.com"
        description = "Looks for a common design pattern in webshells where a request attribute is passed directly to exec()."
        date = "2022-02-02"
        hash1 = "4935f0c50057e28efa7376c734a4c66018f8d20157b6584399146b6c79a6de15"
        license = "See license at https://github.com/volexity/threat-intel/blob/main/LICENSE.txt"
        memory_suitable = 1

    strings:
        $s1 = "Runtime.getRuntime().exec(request." ascii

    condition:
        $s1
}

rule webshell_jsp_reGeorg : Webshell Commodity
{
    meta:
        author = "threatintel@volexity.com"
        description = "Detects the reGeorg webshells' JSP version."
        date = "2022-03-08"
        hash1 = "f9b20324f4239a8c82042d8207e35776d6777b6305974964cd9ccc09d431b845"
        reference = "https://github.com/SecWiki/WebShell-2/blob/master/reGeorg-master/tunnel.jsp"
        license = "See license at https://github.com/volexity/threat-intel/blob/main/LICENSE.txt"
        memory_suitable = 1

    strings:
        $magic = "socketChannel.connect(new InetSocketAddress(target, port))" ascii
        
        $a1 = ".connect(new InetSocketAddress" ascii
        $a2 = ".configureBlocking(false)" ascii
        $a3 = ".setHeader(" ascii
        $a4 = ".getHeader(" ascii
        $a5 = ".flip();" ascii
        
    condition:
        $magic or 
        all of ($a*)
}