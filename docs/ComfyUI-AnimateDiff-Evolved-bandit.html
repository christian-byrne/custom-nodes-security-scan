
<!DOCTYPE html>
<html>
<head>

<meta charset="UTF-8">

<title>
    Bandit Report
</title>

<style>

html * {
    font-family: "Arial", sans-serif;
}

pre {
    font-family: "Monaco", monospace;
}

.bordered-box {
    border: 1px solid black;
    padding-top:.5em;
    padding-bottom:.5em;
    padding-left:1em;
}

.metrics-box {
    font-size: 1.1em;
    line-height: 130%;
}

.metrics-title {
    font-size: 1.5em;
    font-weight: 500;
    margin-bottom: .25em;
}

.issue-description {
    font-size: 1.3em;
    font-weight: 500;
}

.candidate-issues {
    margin-left: 2em;
    border-left: solid 1px; LightGray;
    padding-left: 5%;
    margin-top: .2em;
    margin-bottom: .2em;
}

.issue-block {
    border: 1px solid LightGray;
    padding-left: .5em;
    padding-top: .5em;
    padding-bottom: .5em;
    margin-bottom: .5em;
}

.issue-sev-high {
    background-color: Pink;
}

.issue-sev-medium {
    background-color: NavajoWhite;
}

.issue-sev-low {
    background-color: LightCyan;
}

</style>
</head>

<body>

<div id="metrics">
    <div class="metrics-box bordered-box">
        <div class="metrics-title">
            Metrics:<br>
        </div>
        Total lines of code: <span id="loc">8043</span><br>
        Total lines skipped (#nosec): <span id="nosec">0</span>
    </div>
</div>




<br>
<div id="results">
    
<div id="issue-0">
<div class="issue-block issue-sev-low">
    <b>try_except_pass: </b> Try, Except, Pass detected.<br>
    <b>Test ID:</b> B110<br>
    <b>Severity: </b>LOW<br>
    <b>Confidence: </b>HIGH<br>
    <b>CWE: </b><a href="https://cwe.mitre.org/data/definitions/703.html" target="_blank">CWE-703</a><br>
    <b>File: </b><a href="/ComfyUI-AnimateDiff-Evolved/animatediff/nodes_animatelcmi2v.py" target="_blank">/ComfyUI-AnimateDiff-Evolved/animatediff/nodes_animatelcmi2v.py</a><br>
    <b>Line number: </b>148<br>
    <b>More info: </b><a href="https://bandit.readthedocs.io/en/1.7.9/plugins/b110_try_except_pass.html" target="_blank">https://bandit.readthedocs.io/en/1.7.9/plugins/b110_try_except_pass.html</a><br>

<div class="code">
<pre>
132	        }
133	    
134	    RETURN_TYPES = (&quot;LATENT&quot;,)
135	    FUNCTION = &quot;preprocess_images&quot;
136	
137	    CATEGORY = &quot;Animate Diff üé≠üÖêüÖì/‚ë° Gen2 nodes ‚ë°/AnimateLCM-I2V&quot;
138	
139	    def preprocess_images(self, image: torch.Tensor, vae: VAE, latent_size: torch.Tensor, scale_method: str, crop: str):
140	        b, c, h, w = latent_size[&quot;samples&quot;].size()
141	        image = image.movedim(-1,1)
142	        image = comfy.utils.common_upscale(samples=image, width=w*8, height=h*8, upscale_method=scale_method, crop=crop)
143	        image = image.movedim(1,-1)
144	        # now that images are the expected size, VAEEncode them
145	        try:  # account for old ComfyUI versions (TODO: remove this when other changes require ComfyUI update)
146	            if not hasattr(vae, &quot;vae_encode_crop_pixels&quot;):
147	                image = VAEEncode.vae_encode_crop_pixels(image)
148	        except Exception:
149	            pass
150	        return ({&quot;samples&quot;: vae.encode(image[:,:,:,:3])},)
</pre>
</div>


</div>
</div>

<div id="issue-1">
<div class="issue-block issue-sev-low">
    <b>blacklist: </b> Consider possible security implications associated with the subprocess module.<br>
    <b>Test ID:</b> B404<br>
    <b>Severity: </b>LOW<br>
    <b>Confidence: </b>HIGH<br>
    <b>CWE: </b><a href="https://cwe.mitre.org/data/definitions/78.html" target="_blank">CWE-78</a><br>
    <b>File: </b><a href="/ComfyUI-AnimateDiff-Evolved/animatediff/nodes_deprecated.py" target="_blank">/ComfyUI-AnimateDiff-Evolved/animatediff/nodes_deprecated.py</a><br>
    <b>Line number: </b>4<br>
    <b>More info: </b><a href="https://bandit.readthedocs.io/en/1.7.9/blacklists/blacklist_imports.html#b404-import-subprocess" target="_blank">https://bandit.readthedocs.io/en/1.7.9/blacklists/blacklist_imports.html#b404-import-subprocess</a><br>

<div class="code">
<pre>
1	import json
2	import os
3	import shutil
4	import subprocess
5	from typing import Dict, List
6	
7	import numpy as np
8	import torch
9	from PIL import Image
10	from PIL.PngImagePlugin import PngInfo
11	
12	import folder_paths
13	from comfy.model_patcher import ModelPatcher
14	
15	from .ad_settings import AnimateDiffSettings, AdjustGroup, AdjustPE, AdjustWeight
16	from .context import ContextOptionsGroup, ContextOptions, ContextSchedules
17	from .logger import logger
18	from .utils_model import Folders, BetaSchedules, get_available_motion_models
19	from .model_injection import ModelPatcherAndInjector, InjectionParams, MotionModelGroup, load_motion_module_gen1
20	
21	
22	class AnimateDiffLoader_Deprecated:
23	    @classmethod
24	    def INPUT_TYPES(s):
25	        return {
26	            &quot;required&quot;: {
27	                &quot;model&quot;: (&quot;MODEL&quot;,),
28	                &quot;latents&quot;: (&quot;LATENT&quot;,),
29	                &quot;model_name&quot;: (get_available_motion_models(),),
30	                &quot;unlimited_area_hack&quot;: (&quot;BOOLEAN&quot;, {&quot;default&quot;: False},),
31	                &quot;beta_schedule&quot;: (BetaSchedules.get_alias_list_with_first_element(BetaSchedules.SQRT_LINEAR),),
32	            },
</pre>
</div>


</div>
</div>

<div id="issue-2">
<div class="issue-block issue-sev-low">
    <b>subprocess_without_shell_equals_true: </b> subprocess call - check for execution of untrusted input.<br>
    <b>Test ID:</b> B603<br>
    <b>Severity: </b>LOW<br>
    <b>Confidence: </b>HIGH<br>
    <b>CWE: </b><a href="https://cwe.mitre.org/data/definitions/78.html" target="_blank">CWE-78</a><br>
    <b>File: </b><a href="/ComfyUI-AnimateDiff-Evolved/animatediff/nodes_deprecated.py" target="_blank">/ComfyUI-AnimateDiff-Evolved/animatediff/nodes_deprecated.py</a><br>
    <b>Line number: </b>266<br>
    <b>More info: </b><a href="https://bandit.readthedocs.io/en/1.7.9/plugins/b603_subprocess_without_shell_equals_true.html" target="_blank">https://bandit.readthedocs.io/en/1.7.9/plugins/b603_subprocess_without_shell_equals_true.html</a><br>

<div class="code">
<pre>
250	                #Should never be reachable
251	                raise ProcessLookupError(&quot;Could not find ffmpeg&quot;)
252	
253	            video_format_path = folder_paths.get_full_path(&quot;video_formats&quot;, format_ext + &quot;.json&quot;)
254	            with open(video_format_path, &#x27;r&#x27;) as stream:
255	                video_format = json.load(stream)
256	            file = f&quot;{filename}_{counter:05}_.{video_format[&#x27;extension&#x27;]}&quot;
257	            file_path = os.path.join(full_output_folder, file)
258	            dimensions = f&quot;{frames[0].width}x{frames[0].height}&quot;
259	            args = [ffmpeg_path, &quot;-v&quot;, &quot;error&quot;, &quot;-f&quot;, &quot;rawvideo&quot;, &quot;-pix_fmt&quot;, &quot;rgb24&quot;,
260	                    &quot;-s&quot;, dimensions, &quot;-r&quot;, str(frame_rate), &quot;-i&quot;, &quot;-&quot;] \
261	                    + video_format[&#x27;main_pass&#x27;] + [file_path]
262	
263	            env=os.environ.copy()
264	            if  &quot;environment&quot; in video_format:
265	                env.update(video_format[&quot;environment&quot;])
266	            with subprocess.Popen(args, stdin=subprocess.PIPE, env=env) as proc:
267	                for frame in frames:
268	                    proc.stdin.write(frame.tobytes())
269	
270	        previews = [
271	            {
272	                &quot;filename&quot;: file,
273	                &quot;subfolder&quot;: subfolder,
274	                &quot;type&quot;: &quot;output&quot; if save_image else &quot;temp&quot;,
275	                &quot;format&quot;: format,
276	            }
277	        ]
278	        return {&quot;ui&quot;: {&quot;gifs&quot;: previews}}
279	
280	
281	
</pre>
</div>


</div>
</div>

<div id="issue-3">
<div class="issue-block issue-sev-low">
    <b>try_except_pass: </b> Try, Except, Pass detected.<br>
    <b>Test ID:</b> B110<br>
    <b>Severity: </b>LOW<br>
    <b>Confidence: </b>HIGH<br>
    <b>CWE: </b><a href="https://cwe.mitre.org/data/definitions/703.html" target="_blank">CWE-703</a><br>
    <b>File: </b><a href="/ComfyUI-AnimateDiff-Evolved/animatediff/sampling.py" target="_blank">/ComfyUI-AnimateDiff-Evolved/animatediff/sampling.py</a><br>
    <b>Line number: </b>275<br>
    <b>More info: </b><a href="https://bandit.readthedocs.io/en/1.7.9/plugins/b110_try_except_pass.html" target="_blank">https://bandit.readthedocs.io/en/1.7.9/plugins/b110_try_except_pass.html</a><br>

<div class="code">
<pre>
259	        self.orig_apply_model = model.model.apply_model
260	        # Inject Functions
261	        openaimodel.forward_timestep_embed = forward_timestep_embed_factory()
262	        if params.unlimited_area_hack:
263	            model.model.memory_required = unlimited_memory_required
264	        if model.motion_models is not None:
265	            # only apply groupnorm hack if not [v3 or ([not Hotshot] and SD1.5 and v2 and apply_v2_properly)]
266	            info: AnimateDiffInfo = model.motion_models[0].model.mm_info
267	            if not (info.mm_version == AnimateDiffVersion.V3 or
268	                    (info.mm_format not in [AnimateDiffFormat.HOTSHOTXL] and info.sd_type == ModelTypeSD.SD1_5 and info.mm_version == AnimateDiffVersion.V2 and params.apply_v2_properly)):
269	                torch.nn.GroupNorm.forward = groupnorm_mm_factory(params)
270	                comfy.ops.manual_cast.GroupNorm.forward_comfy_cast_weights = groupnorm_mm_factory(params, manual_cast=True)
271	                # if mps device (Apple Silicon), disable batched conds to avoid black images with groupnorm hack
272	                try:
273	                    if model.load_device.type == &quot;mps&quot;:
274	                        model.model.memory_required = unlimited_memory_required
275	                except Exception:
276	                    pass
277	            # if img_encoder or camera_encoder present, inject apply_model to handle correctly
278	            for motion_model in model.motion_models:
279	                if (motion_model.model.img_encoder is not None) or (motion_model.model.camera_encoder is not None):
280	                    model.model.apply_model = apply_model_factory(self.orig_apply_model).__get__(model.model, type(model.model))
281	                    break
282	            del info
283	        comfy.samplers.sampling_function = evolved_sampling_function
284	        comfy.samplers.get_area_and_mult = get_area_and_mult_ADE
285	        if SAMPLE_FALLBACK:  # for backwards compatibility, for now
286	            comfy.sample.get_additional_models = get_additional_models_factory(self.orig_get_additional_models, model.motion_models)
287	        else:
288	            comfy.sampler_helpers.get_additional_models = get_additional_models_factory(self.orig_get_additional_models, model.motion_models)
289	
290	    def restore_functions(self, model: ModelPatcherAndInjector):
291	        # Restoration
</pre>
</div>


</div>
</div>

<div id="issue-4">
<div class="issue-block issue-sev-low">
    <b>try_except_pass: </b> Try, Except, Pass detected.<br>
    <b>Test ID:</b> B110<br>
    <b>Severity: </b>LOW<br>
    <b>Confidence: </b>HIGH<br>
    <b>CWE: </b><a href="https://cwe.mitre.org/data/definitions/703.html" target="_blank">CWE-703</a><br>
    <b>File: </b><a href="/ComfyUI-AnimateDiff-Evolved/animatediff/utils_model.py" target="_blank">/ComfyUI-AnimateDiff-Evolved/animatediff/utils_model.py</a><br>
    <b>Line number: </b>273<br>
    <b>More info: </b><a href="https://bandit.readthedocs.io/en/1.7.9/plugins/b110_try_except_pass.html" target="_blank">https://bandit.readthedocs.io/en/1.7.9/plugins/b110_try_except_pass.html</a><br>

<div class="code">
<pre>
257	    MOTION_LORA = &quot;animatediff_motion_lora&quot;
258	    VIDEO_FORMATS = &quot;animatediff_video_formats&quot;
259	
260	
261	def add_extension_to_folder_path(folder_name: str, extensions: Union[str, list[str]]):
262	    if folder_name in folder_paths.folder_names_and_paths:
263	        if isinstance(extensions, str):
264	            folder_paths.folder_names_and_paths[folder_name][1].add(extensions)
265	        elif isinstance(extensions, Iterable):
266	            for ext in extensions:
267	                folder_paths.folder_names_and_paths[folder_name][1].add(ext) 
268	
269	
270	def try_mkdir(full_path: str):
271	    try:
272	        Path(full_path).mkdir()
273	    except Exception:
274	        pass
275	
276	
277	# register motion models folder(s)
278	folder_paths.add_model_folder_path(Folders.ANIMATEDIFF_MODELS, str(Path(__file__).parent.parent / &quot;models&quot;))
279	folder_paths.add_model_folder_path(Folders.ANIMATEDIFF_MODELS, str(Path(folder_paths.models_dir) / Folders.ANIMATEDIFF_MODELS))
280	add_extension_to_folder_path(Folders.ANIMATEDIFF_MODELS, folder_paths.supported_pt_extensions)
281	try_mkdir(str(Path(folder_paths.models_dir) / Folders.ANIMATEDIFF_MODELS))
282	
283	# register motion LoRA folder(s)
284	folder_paths.add_model_folder_path(Folders.MOTION_LORA, str(Path(__file__).parent.parent / &quot;motion_lora&quot;))
285	folder_paths.add_model_folder_path(Folders.MOTION_LORA, str(Path(folder_paths.models_dir) / Folders.MOTION_LORA))
286	add_extension_to_folder_path(Folders.MOTION_LORA, folder_paths.supported_pt_extensions)
287	try_mkdir(str(Path(folder_paths.models_dir) / Folders.MOTION_LORA))
288	
289	# register video_formats folder
</pre>
</div>


</div>
</div>

</div>

</body>
</html>
